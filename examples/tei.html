<html>
	<head>
		<!-- Load CSS -->
		<link href="../src/css/bodin.css" rel="stylesheet" type="text/css" />
		<!-- End Load CSS -->
		<title>bodin</title>
		<style type="text/css">
			.TeiToBodin {
				color: #222;
				letter-spacing: .02em;
				line-height: 1.5em;
				padding: 2px;
				background-color: #222;
				width: 100%;
				box-sizing: border-box;
				display: block;
				float: left;
				margin: 0;
			}
			.TeiToBodin .navMenu {}
			.TeiToBodin a {
				display: inline-block;
				color: #FF0000;
				vertical-align: super;
				font-size: 75%;
			}
			.TeiToBodin .work {
				height: 100%;
				overflow-y: scroll;
			}
			.TeiToBodin .page {
				background-color: #F9F9F9;
				padding: 60px 80px 120px 80px;
				margin-bottom: 5px;
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
			}
		</style>
	<head>
	<body>
		<div class="TeiToBodin" id="bodin_french"></div>
		<div class="TeiToBodin" id="bodin_latin"></div>
		<div class="TeiToBodin" id="bodin_english"></div>
	</body>
	
	<!-- Load Javascript -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="../third_party/jslib/src/js/SharedConfig.js"></script>
	<script src="../third_party/jslib/src/js/Styler.js"></script>
	<script src="../third_party/jslib/src/js/DomPlus.js"></script>
	
	<script type="text/javascript"> 
		/**
		 * Takes TEI xml and creates HTML useable by the bodin plugin
		 *
		 * Use: new TeiToBodin( 'xml/tei.xml', 'tei' );
		 *
		 * @param { string } _url The url to the TEI xml
		 * @param { string } _id The id of the DOM object to write HTML output
		 */
		function TeiToBodin( _url, _id ) {
			this.config = {
				timeout: 10 // seconds
			};
			this.url = _url;
			this.id = _id;
			this.xml = null;  // TEI xml retrieved
			this.json = {};	  // json created from TEI xml
			this.html = null; // html created from this.json
			this.notes = [];  // notes
			//------------------------------------------------------------
			//	Check number of instances
			//------------------------------------------------------------
			var shared = new SharedConfig();
			if ( shared.check( 'count' ) == false ) {
				shared.config['count'] = 1;
			}
			else {
				shared.config['count']++;
				this.makeRoom( shared.config['count'] );
			}
			//------------------------------------------------------------
			//	Get the TEI XML
			//------------------------------------------------------------
			this.getXml();
		}
		
		/**
		 * Organize instances of TeiToBodin into columns
		 *
		 * @param {int } _count The number of instances.
		 */
		TeiToBodin.prototype.makeRoom = function( _count ) {
			var styler = new Styler();
			var percent = parseInt( 100/_count );
			styler.add({
				'.TeiToBodin': 'width: '+percent+'%'
			});
		}
		
		/**
		 * Retrieve TEI xml from a URL
		 */
		TeiToBodin.prototype.getXml = function() {
			var self = this;
			jQuery.ajax({
				url: self.url,
				type: 'get',
				timeout: self.config.timeout*1000,
				dataType: 'xml',
				success: function( _data ) {
					self.xml = _data;
					self.start();
				},
				error: function( _error ) {
					console.log( 'Error' );
					console.log( _error );
				}
			});
		}
		
		/**
		 * getXml() was a success!	Start it up!
		 */
		TeiToBodin.prototype.start = function() {
			this.toHtml();
			this.events();
		}
		
		/**
		 * Start UI event listeners
		 */
		TeiToBodin.prototype.events = function() {
			var self = this;
			jQuery( 'note' ).click( function( _e ) {
				var i = jQuery( this ).text()
				console.log(  self.notes[i] );
			})
		}
		
		/**
		 * Takes TEI xml and creates HTML useable by the bodin plugin
		 */
		TeiToBodin.prototype.toHtml = function() {
			//------------------------------------------------------------
			// Extract notes
			//------------------------------------------------------------
			this.getNotes();
			
			//------------------------------------------------------------
			//	Get editions books and pages from the main text
			//------------------------------------------------------------
			this.getBody();
			
			//------------------------------------------------------------
			//	Get publication info
			//------------------------------------------------------------
			this.getPub();
			
			//------------------------------------------------------------
			//	Convert your JSON object to HTML
			//------------------------------------------------------------
			this.jsonToHtml();
		}
		
		/**
		 * Extract publication information from XML
		 */
		TeiToBodin.prototype.getPub = function() {
			var pub = this.xml.getElementsByTagName("fileDesc")[0];
		}
		
		/**
		 * Turn your relatively clean JSON into Bodin Formatted HTML
		 */
		TeiToBodin.prototype.jsonToHtml = function() {
			jQuery( '#'+this.id ).append('<div class="work"></div>');
			var work = '#'+this.id+' .work';
			//------------------------------------------------------------
			//	Editions
			//------------------------------------------------------------
			for ( var i=0, ii=this.json['editions'].length; i<ii; i++ ) {
				var edition = this.id+'-edition-'+i;
				jQuery( work ).append('<div id="'+edition+'" class="edition"></div>');
				//------------------------------------------------------------
				//	Books
				//------------------------------------------------------------
				for ( var j=0, jj=this.json['editions'][i]['books'].length; j<jj; j++ ) {
					var book = edition+'-book-'+j;
					jQuery( '#'+edition ).append('<div id="'+book+'" class="book"></div>');
					//------------------------------------------------------------
					//	Chapters
					//------------------------------------------------------------
					for ( var k=0, kk=this.json['editions'][i]['books'][j]['chapters'].length; k<kk; k++ ) {
						var chapter = book+'-chapter-'+k;
						jQuery( '#'+book ).append('<div id="'+chapter+'" class="chapter"></div>');
						//------------------------------------------------------------
						//	Pages
						//------------------------------------------------------------
						for ( var m=0, mm=this.json['editions'][i]['books'][j]['chapters'][k]['pages'].length; m<mm; m++ ) {
							var page = chapter+'-page-'+m;
							var text = this.json['editions'][i]['books'][j]['chapters'][k]['pages'][m];
							jQuery( '#'+chapter ).append('<div id="'+page+'" class="page">'+text+'</div>');
						}
					}
				}
			}
		}
		
		/**
		 * Extract editions, books, and chapters from the main text body
		 */
		TeiToBodin.prototype.getBody = function() {
			var text = this.xml.getElementsByTagName("text")[0];
			this.json['editions'] = [];
			var editions = DomPlus.getByAttrValue( text, 'type', 'edition', 'div' );
			//------------------------------------------------------------
			//	Find editions
			//------------------------------------------------------------
			for ( var i=0, ii=editions.length; i<ii; i++ ) {
				this.json['editions'][i] = {};
				var books = DomPlus.getByAttrValue( editions[i], 'subtype', 'book', 'div' );
				//------------------------------------------------------------
				//	Find books
				//------------------------------------------------------------
				this.json['editions'][i]['books'] = [];
				for ( var j=0, jj=books.length; j<jj; j++ ) {
					this.json['editions'][i]['books'][j] = {};
					var chapters = DomPlus.getByAttrValue( books[j], 'subtype', 'chapter', 'div' );
					//------------------------------------------------------------
					//	Record the book title
					//------------------------------------------------------------
					this.json['editions'][i]['books'][j]['head'] = books[j].getElementsByTagName("head")[0];
					//------------------------------------------------------------
					//	Find chapters
					//------------------------------------------------------------
					this.json['editions'][i]['books'][j]['chapters'] = [];
					for ( var k=0, kk=chapters.length; k<kk; k++ ) {
						//------------------------------------------------------------
						//	Get chapter title
						//------------------------------------------------------------
						this.json['editions'][i]['books'][j]['chapters'][k] = {};
						this.json['editions'][i]['books'][j]['chapters'][k]['head'] = chapters[k].getElementsByTagName("head")[0];
						//------------------------------------------------------------
						//	Get pages
						//------------------------------------------------------------
						var pages = chapters[k].innerHTML.split( /<pb.*\/>/ ); // not sure if this split is too aggressive.
						this.json['editions'][i]['books'][j]['chapters'][k]['pages'] = pages;
					}
				}
			}
		}
		
		/**
		 * Extract note tags
		 */
		TeiToBodin.prototype.getNotes = function() {
			var noteXml = this.xml.getElementsByTagName("note");
			var i=noteXml.length-1;
			while ( i>=0 ) {
				//------------------------------------------------------------
				//  Pull the notes HTML out.
				//------------------------------------------------------------
				this.notes[i] = noteXml[i].innerHTML;
				//------------------------------------------------------------
				//  Change notes to anchor tags.
				//------------------------------------------------------------
				noteXml[i].innerHTML = i+1;
				noteXml[i].setAttribute( 'href', '#'+(i+1) );
				noteXml[i] = DomPlus.tagChange( noteXml[i], "a" );
				i--;
			}
		}
		
		jQuery( document ).ready( function() {
			new TeiToBodin( 'xml/bodin_french.xml', 'bodin_french' );
			new TeiToBodin( 'xml/bodin_french.xml', 'bodin_latin' );
//			new TeiToBodin( 'xml/bodin_french.xml', 'bodin_english' );
		});
		
		// console.log( _xml.getElementsByTagName("text") );
		// console.log( _xml.getElementsByTagName("text")[0].innerHTML );
		// console.log( _xml.getElementsByTagName("text")[0].childNodes[0].nodeValue );
	</script>
<html>
