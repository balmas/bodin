<html>
	<head>
		<!-- Load CSS -->
		<!-- End Load CSS -->
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
		<title>bodin</title>
		<style type="text/css">
			.TeiToBodin {
				color: #222;
				letter-spacing: .02em;
				line-height: 1.5em;
				padding: 2px;
				background-color: #222;
				width: 100%;
				box-sizing: border-box;
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				display: block;
				float: left;
				margin: 0;
			}
			.TeiToBodin .navMenu {}
			.TeiToBodin a.note {
				display: inline-block;
				color: #FF0000;
				vertical-align: super;
				font-size: 75%;
				text-decoration: none;
			}
			.TeiToBodin .work {
				height: 100%;
				overflow-y: scroll;
			}
			.TeiToBodin .page {
				background-color: #F9F9F9;
				padding: 60px 80px 120px 80px;
				margin-bottom: 5px;
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
			}
			.TeiToBodin.slim .page {
				padding: 60px 30px 120px 30px;
			}
			#tooltipper {
				text-decoration: none;
				display: block;
				text-align: center;
				color: #fff;
				background: #111;
				position: absolute;
				z-index: 9999;
				padding: 15px;
			}
			#tooltipper:after {
				width: 0;
				height: 0;
				border-left: 10px solid transparent;
				border-right: 10px solid transparent;
				border-top: 10px solid #111;
				content: '';
				position: absolute;
				left: 50%;
				bottom: -10px;
				margin-left: -10px;
			}
			#tooltipper.top:after {
				border-top-color: transparent;
				border-bottom: 10px solid #111;
				top: -20px;
				bottom: auto;
			}
			#tooltipper.left:after {
				left: 10px;
				margin: 0;
			}
			#tooltipper.right:after {
				right: 10px;
				left: auto;
				margin: 0;
			}
		</style>
	<head>
	<body>
		<div class="TeiToBodin" id="bodin_latin"></div>
		<div class="TeiToBodin" id="bodin_english"></div>
	</body>
	
	<!-- Load Javascript -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="../third_party/jslib/src/js/SharedConfig.js"></script>
	<script src="../third_party/jslib/src/js/Styler.js"></script>
	<script src="../third_party/jslib/src/js/StringExt.js"></script>
	<script src="../third_party/jslib/src/js/DomPlus.js"></script>
	
	<script type="text/javascript">
		/**
		 * Align bodin texts
		 */
		function BodinAligner( _url  ) {}
		
		/**
		 * Takes TEI xml and creates HTML useable by the bodin plugin
		 *
		 * Use: new TeiToBodin( 'xml/tei.xml', 'tei' );
		 *
		 * @param { string } _url The url to the TEI xml
		 * @param { string } _id The id of the DOM object to write HTML output
		 */
		function TeiToBodin( _url, _id ) {
			this.config = {
				timeout: 10, // seconds
				xslUrl: "xslt/bodin.xsl"
			};
			this.url = _url;
			this.id = _id;
			this.tei = null;  // TEI xml retrieved
			this.xsl = null;  // xsl retrieved
			//------------------------------------------------------------
			//	Check number of instances
			//------------------------------------------------------------
			var shared = new SharedConfig();
			if ( shared.check( 'count' ) == false ) {
				shared.config['count'] = 1;
			}
			else {
				shared.config['count']++;
				this.makeRoom( shared.config['count'] );
			}
			//------------------------------------------------------------
			//	Get the TEI XML
			//------------------------------------------------------------
			this.getTei();
		}
		
		/**
		 * Organize instances of TeiToBodin into columns
		 *
		 * @param {int } _count The number of instances.
		 */
		TeiToBodin.prototype.makeRoom = function( _count ) {
			var styler = new Styler();
			var percent = parseInt( 100/_count );
			styler.add({
				'.TeiToBodin': 'width: '+percent+'%'
			});
		}
		
		/**
		 * Check the size of the instance.
		 */
		TeiToBodin.prototype.sizeCheck = function() {
			var self = this;
			jQuery( window ).resize( function() {
				var elem = jQuery( '#'+self.id );
				if ( elem.width() < 450 ) {
					elem.addClass('slim');
				}
				else {
					elem.removeClass('slim');
				}
			});
		}
		
		/**
		 * Retrieve TEI xml from a URL
		 */
		TeiToBodin.prototype.getTei = function() {
			var self = this;
			jQuery.ajax({
				url: self.url,
				type: 'get',
				timeout: self.config.timeout*1000,
				dataType: 'xml',
				success: function( _data ) {
					self.tei = _data;
					self.getXsl();
				},
				error: function( _error ) {
					console.log( 'Error getXml' );
					console.log( _error );
				}
			});
		}
		
		TeiToBodin.prototype.getXsl = function() {
			var self = this;
			jQuery.ajax({
				url: self.config.xslUrl,
				type: 'get',
				timeout: self.config.timeout*1000,
				dataType: 'xml',
				success: function( _data ) {
					self.xsl = _data;
					self.start();
				},
				error: function( _error ) {
					console.log( 'Error getXsl');
					console.log( _error );
				}
			})
		}
		
		/**
		 * getXml() was a success!	Start it up!
		 */
		TeiToBodin.prototype.start = function() {
			this.toHtml();
			this.events();
			//------------------------------------------------------------
			//  Start tooltips
			//  Pass along to the parent "overflow-y: scroll" element.
			//------------------------------------------------------------
			new Tooltipper( '#'+this.id+' .work' );
		}
		
		/**
		 * Start UI event listeners
		 */
		TeiToBodin.prototype.events = function() {
			this.sizeCheck();
		}
		
		/**
		 * Takes TEI xml and creates HTML useable by the bodin plugin
		 */
		TeiToBodin.prototype.toHtml = function() {
			var xslt = new XSLTProcessor();
			xslt.importStylesheet( this.xsl );
			this.bodinHtml = xslt.transformToFragment( this.tei, document );
			console.dir( this.bodinHtml );
			jQuery( '#'+this.id ).append( this.bodinHtml );
		}
		
		
		function Tooltipper( _root ) {
			this.root = _root;
			this.tooltip = jQuery( '<a href="#" id="tooltipper"></a>' );
			this.start();
			this.target = null;
		}
		
		Tooltipper.prototype.start = function() {
			var self = this;
			//------------------------------------------------------------
			//  Click listener
			//------------------------------------------------------------
			jQuery( self.root + ' [rel~=tooltip]' ).on( 'touchstart click', function( _e ) {
				_e.preventDefault;
				//------------------------------------------------------------
				//  Store reference to clicked element.
				//------------------------------------------------------------
				var clicked = jQuery(this);
				if ( self.target === clicked ) {
					return;
				}
				self.target = clicked;
				//------------------------------------------------------------
				//  Remove existing tooltip
				//------------------------------------------------------------
				self.remove();
				//------------------------------------------------------------
				//  Check for title
				//------------------------------------------------------------
				var tip = jQuery( this ).attr( 'title' );
				if ( !tip || tip == '' ) {
					return false;
				}
				//------------------------------------------------------------
				//  Add the tooltip.
				//------------------------------------------------------------
				self.tooltip.html( tip );
				self.tooltip.appendTo( 'body' );
				self.tooltip.css( 'opacity', 0 );
				//------------------------------------------------------------
				//  Position it.
				//------------------------------------------------------------
				self.position();
			});
			//------------------------------------------------------------
			//  Listen for events that require repositioning
			//------------------------------------------------------------
			jQuery( window ).resize( function(){ self.position() });
			jQuery( self.root ).scroll( function(){ self.position() });
			//------------------------------------------------------------
			//  Listen for close click.
			//------------------------------------------------------------
			self.closeClick();
		}
		Tooltipper.prototype.closeClick = function() {
			var self = this;
			jQuery( self.root ).on( 'touchstart click', function( _e ) {
				_e.preventDefault();
				if ( self.target == null ) {
					return;
				}
				//------------------------------------------------------------
				//  Ignore clicks on same target
				//------------------------------------------------------------
				if ( _e.originalEvent.srcElement === self.target[0] ) {
					return;
				}
				self.remove();
			});
		}
		Tooltipper.prototype.remove = function() {
			this.tooltip.remove();
		}
		
		Tooltipper.prototype.position = function() {
			//------------------------------------------------------------
			//  Only procceed if you have what you need.
			//------------------------------------------------------------
			if ( this.tooltip == undefined || this.target == undefined ) {
				return;
			}
			//------------------------------------------------------------
			//  Calculate the position of tooltip relative to the target.
			//------------------------------------------------------------ 
			if ( jQuery( window ).width() < this.tooltip.outerWidth() * 1.5 ) {
				this.tooltip.css( 'max-width', jQuery( window ).width() / 2 );
			}
			else {
				this.tooltip.css( 'max-width', 340 );
			}
			var pos_left = this.target.offset().left + ( this.target.outerWidth() / 2 ) - ( this.tooltip.outerWidth() / 2 );
			var pos_top  = this.target.offset().top - this.tooltip.outerHeight() - 5;
			if ( pos_left < 0 ) {
				pos_left = this.target.offset().left + this.target.outerWidth() / 2 - 20;
				this.tooltip.addClass( 'left' );
			}
			else {
				this.tooltip.removeClass( 'left' );
			}
			if ( pos_left + this.tooltip.outerWidth() > jQuery( window ).width() ) {
				pos_left = this.target.offset().left - this.tooltip.outerWidth() + this.target.outerWidth() / 2 + 20;
				this.tooltip.addClass( 'right' );
			}
			else {
				this.tooltip.removeClass( 'right' );
			}
			if ( pos_top < 0 ) {
				var pos_top  = this.target.offset().top + this.target.outerHeight();
				this.tooltip.addClass( 'top' );
			}
			else {
				this.tooltip.removeClass( 'top' );
			}
			//------------------------------------------------------------
			//  Position that tooltip!
			//------------------------------------------------------------
			this.tooltip.css({ 
				left: pos_left, 
				top: pos_top 
			});
			this.tooltip.animate({
				opacity: 1 
			}, 50 );
		}
		
		/**
		 * When the document is ready start it up.
		 */
		jQuery( document ).ready( function() {
			new TeiToBodin( 'xml/passage.xml', 'bodin_latin' );
			//new TeiToBodin( 'xml/english_translation.xml', 'bodin_english' );
			// new TeiToBodin( 'xml/bodin_french.xml', 'bodin_english' );
		});
	</script>
<html>
