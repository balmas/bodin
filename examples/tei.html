<html>
	<head>
		<!-- Load CSS -->
		<link href="../third_party/sidecart/src/css/sidecart.css" rel="stylesheet" type="text/css" />
		<link href="../src/css/bodin.css" rel="stylesheet" type="text/css" />
		<!-- End Load CSS -->
		<title>bodin</title>
		<style type="text/css">
			.TeiToBodin {
				color: #222;
				letter-spacing: .02em;
				line-height: 1.5em;
				padding: 2px;
				background-color: #222;
				width: 100%;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				display: block;
				float: left;
				margin: 0;
			}
			.TeiToBodin .navMenu {}
			.TeiToBodin a.note {
				display: inline-block;
				color: #FF0000;
				vertical-align: super;
				font-size: 75%;
				text-decoration: none;
			}
			.TeiToBodin .work {
				height: 100%;
				overflow-y: scroll;
			}
			.TeiToBodin .page {
				background-color: #F9F9F9;
				padding: 60px 80px 120px 80px;
				margin-bottom: 5px;
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
			}
			.TeiToBodin.slim .page{
				padding: 60px 30px 120px 30px;
			}
			#tooltipper {
				text-align: center;
				color: #fff;
				background: #111;
				position: absolute;
				z-index: 100;
				padding: 15px;
			}
			#tooltipper:after {
				width: 0;
				height: 0;
				border-left: 10px solid transparent;
				border-right: 10px solid transparent;
				border-top: 10px solid #111;
				content: '';
				position: absolute;
				left: 50%;
				bottom: -10px;
				margin-left: -10px;
			}
			#tooltipper.top:after {
				border-top-color: transparent;
				border-bottom: 10px solid #111;
				top: -20px;
				bottom: auto;
			}
			#tooltipper.left:after {
				left: 10px;
				margin: 0;
			}
			#tooltipper.right:after {
				right: 10px;
				left: auto;
				margin: 0;
			}
			body > #content {
				display: none;
			}
		</style>
	<head>
	<body>
		<div id="content">Sidecart oh yeah.</div>
		<div class="TeiToBodin" id="bodin_latin"><div id="sidecart_latin"></div></div>
		<div class="TeiToBodin" id="bodin_english"><div id="sidecart_english"></div></div>
	</body>
	
	
	
	<!-- Load Javascript -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="../third_party/sidecart/src/js/sidecart.js"></script>
	<script src="../third_party/jslib/src/js/SharedConfig.js"></script>
	<script src="../third_party/jslib/src/js/Styler.js"></script>
	<script src="../third_party/jslib/src/js/StringExt.js"></script>
	<script src="../third_party/jslib/src/js/DomPlus.js"></script>
	
	<script type="text/javascript"> 
		
		function BodinAlign( _url, _id1, _id2 ) {
			this.config = {
				timeout: 10 // seconds
			};
			this.xml = null;
			this.url = _url;
			this.id1 = _id1;
			this.id2 = _id2;
			this.readyCount = 0;
			//------------------------------------------------------------
			//  This is where target/body pairs are stored.
			//------------------------------------------------------------
			this.map = [];
			//------------------------------------------------------------
			//  Listen for TeiToBodin to complete
			//------------------------------------------------------------
			this.listen();
			//------------------------------------------------------------
			//  Return this.
			//------------------------------------------------------------
			return this;
		}
		
		BodinAlign.prototype.listen = function() {
			var self = this;
			jQuery( '#'+self.id1).on( 'TeiToBodin-READY', function(){
				self.readyCount+=1;
				self.start();
			});
			jQuery( '#'+self.id2).on( 'TeiToBodin-READY', function(){
				self.readyCount+=1;
				self.start();
			});
		}
		
		BodinAlign.prototype.getXml = function() {
			var self = this;
			jQuery.ajax({
				url: self.url,
				type: 'get',
				timeout: self.config.timeout*1000,
				dataType: 'xml',
				success: function( _data ) {
					self.xml = _data;
					self.getAlignMap();
					self.alignMarkup();
				},
				error: function( _error ) {
					console.log( 'Error' );
					console.log( _error );
				}
			});
		}
		
		BodinAlign.prototype.alignMarkup = function() {
			var self = this;
			DomWalk( document.getElementById( self.id1 ), function( _node ) {
				//console.log( _node.innerHTML )
			});
		}
		
		BodinAlign.prototype.getAlignMap = function() {
			var self = this;
			jQuery( self.xml ).find('Annotation').each( function(){
				var annot = this;
				//------------------------------------------------------------
				//  Get the target
				//------------------------------------------------------------
				var target = jQuery( annot ).find('hasTarget');
				target = jQuery(target[0]).attr('rdf:resource');
				target = self.jsonTarget( target );
				if ( target == undefined ) {
					return true; // a continue in jQuery().each() land
				}
				//------------------------------------------------------------
				//  Get the body
				//------------------------------------------------------------
				var body = jQuery( annot ).find('hasBody');
				body = jQuery(body[0]).attr('rdf:resource');
				body = self.jsonTarget( body );
				if ( target == undefined ) {
					return true; // a continue in jQuery().each() land
				}
				self.map.push({ target: target, body: body });
			});
		}
		
		BodinAlign.prototype.jsonTarget = function( _target ) {
			//------------------------------------------------------------
			//  Make sure _target is valid
			//------------------------------------------------------------
			var at = _target.indexOf('@')
			if ( at == -1 ) {
				return undefined;
			}
			_target = _target.substr( at , _target.length-1 );
			_target = _target.replace('@','');
			var index = _target.split('-');
			var start = this.wordAndOccurence( index[0] );
			var end = this.wordAndOccurence( index[1] );
			return { 'start': start, 'end': end }
		}
		
		BodinAlign.prototype.wordAndOccurence = function( _string ) {
			var sep = _string.indexOf('[')
			var word = _string.substr( 0 , sep - 1 )
			var occurence = _string.substr( sep, _string.length-1 ).replace('[','').replace(']','');
			return { 'word': word, 'occurence': occurence }
		}
		
		BodinAlign.prototype.start = function() {
			if ( this.readyCount == 2 ) {
				this.getXml();
				startSidecart();
			}
		}
		
		/**
		 * Takes TEI xml and creates HTML useable by the bodin plugin
		 *
		 * Use: new TeiToBodin( 'xml/tei.xml', 'tei' );
		 *
		 * @param { string } _url The url to the TEI xml
		 * @param { string } _id The id of the DOM object to write HTML output
		 */
		function TeiToBodin( _url, _id ) {
			this.config = {
				timeout: 10 // seconds
			};
			this.events = {
				ready: 'TeiToBodin-READY'
			}
			this.url = _url;
			this.id = _id;
			this.xml = null;  // TEI xml retrieved
			this.json = {};	  // json created from TEI xml
			this.html = null; // html created from this.json
			this.notes = [];  // notes
			//------------------------------------------------------------
			//	Check number of instances
			//------------------------------------------------------------
			var shared = new SharedConfig();
			if ( shared.check( 'count' ) == false ) {
				shared.config['count'] = 1;
			}
			else {
				shared.config['count']++;
				this.makeRoom( shared.config['count'] );
			}
			//------------------------------------------------------------
			//	Get the TEI XML
			//------------------------------------------------------------
			this.getXml();
		}
		
		/**
		 * Organize instances of TeiToBodin into columns
		 *
		 * @param {int } _count The number of instances.
		 */
		TeiToBodin.prototype.makeRoom = function( _count ) {
			var styler = new Styler();
			var percent = parseInt( 100/_count );
			styler.add({
				'.TeiToBodin': 'width: '+percent+'%'
			});
		}
		
		/**
		 * Check the size of the instance.
		 */
		TeiToBodin.prototype.sizeCheck = function() {
			var self = this;
			jQuery( window ).resize( function() {
				var elem = jQuery( '#'+self.id );
				if ( elem.width() < 450 ) {
					elem.addClass('slim');
				}
				else {
					elem.removeClass('slim');
				}
			});
		}
		
		/**
		 * Retrieve TEI xml from a URL
		 */
		TeiToBodin.prototype.getXml = function() {
			var self = this;
			jQuery.ajax({
				url: self.url,
				type: 'get',
				timeout: self.config.timeout*1000,
				dataType: 'xml',
				success: function( _data ) {
					self.xml = _data;
					self.start();
				},
				error: function( _error ) {
					console.log( 'Error' );
					console.log( _error );
				}
			});
		}
		
		/**
		 * getXml() was a success!	Start it up!
		 */
		TeiToBodin.prototype.start = function() {
			this.toHtml();
			this.listen();
			//------------------------------------------------------------
			//  Start tooltips
			//  Pass along the parent "overflow-y: scroll" element.
			//------------------------------------------------------------
			new Tooltipper( '#'+this.id+' .work' );
		}
		
		/**
		 * Start UI event listeners
		 */
		TeiToBodin.prototype.listen = function() {
			var self = this;
			self.sizeCheck();
		}
		
		/**
		 * Takes TEI xml and creates HTML useable by the bodin plugin
		 */
		TeiToBodin.prototype.toHtml = function() {
			//------------------------------------------------------------
			// Extract notes
			//------------------------------------------------------------
			this.getNotes();
			//------------------------------------------------------------
			//	Get editions books and pages from the main text
			//------------------------------------------------------------
			this.getBody();
			//------------------------------------------------------------
			//	Get publication info
			//------------------------------------------------------------
			this.getPub();
			//------------------------------------------------------------
			//	Convert your JSON object to HTML
			//------------------------------------------------------------
			this.jsonToHtml();
			//------------------------------------------------------------
			//  Announce your "readiness"
			//------------------------------------------------------------
			jQuery( '#'+this.id ).trigger( this.events['ready'] );
		}
		
		/**
		 * Extract publication information from XML
		 */
		TeiToBodin.prototype.getPub = function() {
			var pub = this.xml.getElementsByTagName("fileDesc")[0];
		}
		
		/**
		 * Turn your relatively clean JSON into Bodin Formatted HTML
		 */
		TeiToBodin.prototype.jsonToHtml = function() {
			jQuery( '#'+this.id ).append('<div class="work"></div>');
			var work = '#'+this.id+' .work';
			//------------------------------------------------------------
			//	Editions
			//------------------------------------------------------------
			for ( var i=0, ii=this.json['editions'].length; i<ii; i++ ) {
				var edition = this.id+'-edition-'+(i+1);
				jQuery( work ).append('<div id="'+edition+'" class="edition"></div>');
				//------------------------------------------------------------
				//	Books
				//------------------------------------------------------------
				for ( var j=0, jj=this.json['editions'][i]['books'].length; j<jj; j++ ) {
					var book = edition+'-book-'+(j+1);
					jQuery( '#'+edition ).append('<div id="'+book+'" class="book"></div>');
					//------------------------------------------------------------
					//	Chapters
					//------------------------------------------------------------
					for ( var k=0, kk=this.json['editions'][i]['books'][j]['chapters'].length; k<kk; k++ ) {
						var chapter = book+'-chapter-'+(k+1);
						jQuery( '#'+book ).append('<div id="'+chapter+'" class="chapter"></div>');
						//------------------------------------------------------------
						//	Pages
						//------------------------------------------------------------
						for ( var m=0, mm=this.json['editions'][i]['books'][j]['chapters'][k]['pages'].length; m<mm; m++ ) {
							var page = chapter+'-page-'+(m+1);
							var text = this.json['editions'][i]['books'][j]['chapters'][k]['pages'][m];
							jQuery( '#'+chapter ).append('<div id="'+page+'" class="page">'+text+'</div>');
						}
					}
				}
			}
		}
		
		/**
		 * Extract editions, books, and chapters from the main text body
		 */
		TeiToBodin.prototype.getBody = function() {
			var text = this.xml.getElementsByTagName("text")[0];
			this.json['editions'] = [];
			var editions = DomPlus.getByAttrValue( text, 'type', 'edition', 'div' );
			//------------------------------------------------------------
			//	Find editions
			//------------------------------------------------------------
			for ( var i=0, ii=editions.length; i<ii; i++ ) {
				this.json['editions'][i] = {};
				var books = DomPlus.getByAttrValue( editions[i], 'subtype', 'book', 'div' );
				//------------------------------------------------------------
				//	Find books
				//------------------------------------------------------------
				this.json['editions'][i]['books'] = [];
				for ( var j=0, jj=books.length; j<jj; j++ ) {
					this.json['editions'][i]['books'][j] = {};
					var chapters = DomPlus.getByAttrValue( books[j], 'subtype', 'chapter', 'div' );
					//------------------------------------------------------------
					//	Record the book title
					//------------------------------------------------------------
					this.json['editions'][i]['books'][j]['head'] = books[j].getElementsByTagName("head")[0];
					//------------------------------------------------------------
					//	Find chapters
					//------------------------------------------------------------
					this.json['editions'][i]['books'][j]['chapters'] = [];
					for ( var k=0, kk=chapters.length; k<kk; k++ ) {
						//------------------------------------------------------------
						//	Get chapter title
						//------------------------------------------------------------
						this.json['editions'][i]['books'][j]['chapters'][k] = {};
						this.json['editions'][i]['books'][j]['chapters'][k]['head'] = chapters[k].getElementsByTagName("head")[0];
						//------------------------------------------------------------
						//	Get pages
						//------------------------------------------------------------
						
						var pages = chapters[k].innerHTML.split( /<pb.*\/>/ ); // not sure if this split is too aggressive.
						this.json['editions'][i]['books'][j]['chapters'][k]['pages'] = pages;
					}
				}
			}
		}
		
		/**
		 * Extract note tags
		 */
		TeiToBodin.prototype.getNotes = function() {
			var noteXml = this.xml.getElementsByTagName("note");
			var i=noteXml.length-1;
			while ( i>=0 ) {
				//------------------------------------------------------------
				//  Pull the notes HTML out.
				//  Note:  I'm using jQuery().html instead of innerHTML
				//  because of Safari
				//------------------------------------------------------------
				this.notes[i] = jQuery( noteXml[i] ).text();
				//------------------------------------------------------------
				//  Change notes to anchor tags.
				//------------------------------------------------------------
				jQuery( noteXml[i] ).text( i+1 );
				noteXml[i].setAttribute( 'href', '#'+(i+1) );
				noteXml[i].setAttribute( 'title', this.notes[i].smoosh() );
				noteXml[i].setAttribute( 'class', 'note' );
				noteXml[i].setAttribute( 'rel', 'tooltip' );
				noteXml[i] = DomPlus.tagChange( noteXml[i], "a" );
				i--;
			}
		}
		
		/**
		 * Build navigation -- used by sidecart
		 */
		TeiToBodin.prototype.buildNav = function() {
			var output = '<ul>'
			//------------------------------------------------------------
			//	Editions
			//------------------------------------------------------------
			for ( var i=0, ii=this.json['editions'].length; i<ii; i++ ) {
				var edition = this.id+'-edition-'+(i+1);
				//------------------------------------------------------------
				//	Books
				//------------------------------------------------------------
				for ( var j=0, jj=this.json['editions'][i]['books'].length; j<jj; j++ ) {
					var book = edition+'-book-'+(j+1);
					var title = jQuery(this.json['editions'][i]['books'][j]['head']).text();
					output += '<li><a class="book" href="#'+book+'">'+title+'</a><ul>';
					//------------------------------------------------------------
					//	Chapters
					//------------------------------------------------------------
					for ( var k=0, kk=this.json['editions'][i]['books'][j]['chapters'].length; k<kk; k++ ) {
						var chapter = book+'-chapter-'+(k+1);
						title = jQuery(this.json['editions'][i]['books'][j]['chapters'][k]['head']).text();
						output += '<li><a class="chapter" href="#'+chapter+'">'+title+'</li>';
					}
					output += '</ul></li>'
				}
			}
			output += '</ul>';
			return output;
		}
		
		function Tooltipper( _root ) {
			this.root = _root;
			this.tooltip = jQuery( '<div id="tooltipper"></div>' );
			this.start();
			this.target = null;
		}
		
		Tooltipper.prototype.start = function() {
			var self = this;
			//------------------------------------------------------------
			//  Click listener
			//------------------------------------------------------------
			jQuery( self.root + ' [rel~=tooltip]' ).bind( 'touchstart click', function( _e ) {
				_e.preventDefault;
				//------------------------------------------------------------
				//  Store reference to clicked element.
				//------------------------------------------------------------
				self.target = jQuery(this);
				//------------------------------------------------------------
				//  Remove existing tooltip
				//------------------------------------------------------------
				jQuery( self.root+' #tooltipper' ).remove();
				//------------------------------------------------------------
				//  Check for title
				//------------------------------------------------------------
				var tip = jQuery( this ).attr( 'title' );
				if ( !tip || tip == '' ) {
					return false;
				}
				//------------------------------------------------------------
				//  Add the tooltip.
				//------------------------------------------------------------
				self.tooltip.css( 'opacity', 0 ).html( tip ).appendTo( 'body' );
				//------------------------------------------------------------
				//  Position it.
				//------------------------------------------------------------
				self.position();
			});
			//------------------------------------------------------------
			//  Listen for events that require repositioning
			//------------------------------------------------------------
			jQuery( window ).resize( self.position() );
			jQuery( self.root ).scroll( function() {
				self.position() 
			});
		}
		
		Tooltipper.prototype.position = function() {
			//------------------------------------------------------------
			//  Only procceed if you have what you need.
			//------------------------------------------------------------
			if ( this.tooltip == undefined || this.target == undefined ) {
				return;
			}
			//------------------------------------------------------------
			//  Calculate the position of tooltip relative to the target.
			//------------------------------------------------------------ 
			if ( jQuery( window ).width() < this.tooltip.outerWidth() * 1.5 ) {
				this.tooltip.css( 'max-width', jQuery( window ).width() / 2 );
			}
			else {
				this.tooltip.css( 'max-width', 340 );
			}
			var pos_left = this.target.offset().left + ( this.target.outerWidth() / 2 ) - ( this.tooltip.outerWidth() / 2 );
			var pos_top  = this.target.offset().top - this.tooltip.outerHeight() - 5;
			if ( pos_left < 0 ) {
				pos_left = this.target.offset().left + this.target.outerWidth() / 2 - 20;
				this.tooltip.addClass( 'left' );
			}
			else {
				this.tooltip.removeClass( 'left' );
			}
			if ( pos_left + this.tooltip.outerWidth() > jQuery( window ).width() ) {
				pos_left = this.target.offset().left - this.tooltip.outerWidth() + this.target.outerWidth() / 2 + 20;
				this.tooltip.addClass( 'right' );
			}
			else {
				this.tooltip.removeClass( 'right' );
			}
			if ( pos_top < 0 ) {
				var pos_top  = this.target.offset().top + this.target.outerHeight();
				this.tooltip.addClass( 'top' );
			}
			else {
				this.tooltip.removeClass( 'top' );
			}
			//------------------------------------------------------------
			//  Position that tooltip!
			//------------------------------------------------------------
			this.tooltip.css({ 
				left: pos_left, 
				top: pos_top 
			});
			this.tooltip.animate({
				opacity: 1 
			}, 50 );
		}
		
		var DomWalk = function walk( _node, _func ) {
			_func( _node );
			_node = _node.firstChild;
			while ( _node ) {
				walk( _node, _func);
				_node = _node.nextSibling;
		    }
		};
		
		/**
		 * Extract note tags
		 */
		var htmlToFragment = function(html) {
			var retval = document.createDocumentFragment();
			var currentParent = retval;

			HTMLParser(html, {
				start: function(tag, attrs, unary) {
					var node = document.createElement(tag);
					for (var i = 0; i < attrs.length; i++) {
						node.setAttribute(attrs[i].name, attrs[i].value);
					}
					currentParent.appendChild(node);
					if (!unary) {
						currentParent = node;
					}
				},

				end: function(tag) {
					currentParent = currentParent.parentNode || retval;
				},

				chars: function(text) {
					currentParent.appendChild(document.createTextNode(text));
				},

				comment: function(text) {
					currentParent.appendChild(document.createComment(text));
				}
			});
			return retval;
		};
		//------------------------------------------------------------
		// This is a workaround for bug #336, also seen in:
		// http://blog.johnmckerrell.com/2007/03/07/problems-with-safari-and-innerhtml/
		//------------------------------------------------------------
		jQuery.fn.safeHtml = function(html) {
			for (var i = 0; i < this.length; i++) {
				var element = this[i];
				element.innerHTML = html;
				if (html != "" && element.childNodes.length < 1) {
					element.appendChild( htmlToFragment(html) );
				}
			}
			return this;
		};
		var jQueryHtml = jQuery.fn.html;
		jQuery.fn.html = function(html) {
			if (typeof(html) != "string" || arguments.length != 1) {
				return jQueryHtml.apply(this, arguments);
			}
			return this.safeHtml(html);
		};
		
		
		/**
		 * When the document is ready start it up.
		 */
		var latinBodin = null;
		var englishBodin = null;
		jQuery( document ).ready( function() {
			new BodinAlign( 'xml/alignment.xml', 'bodin_latin', 'bodin_english')
			latinBodin = new TeiToBodin( 'xml/passage.xml', 'bodin_latin' );
			englishBodin = new TeiToBodin( 'xml/english_translation.xml', 'bodin_english' );
		});
		
		/**
		 * Start up side-cart.
		 */
		function startSidecart() {
			//------------------------------------------------------------
			//  Side Cart Latin
			//------------------------------------------------------------
			jQuery('#sidecart_latin').sidecart({
				side: 'top',
				inside: true,
				views: [
					{
						id: 'nav-1',
						type: 'nav',
						link: 'NAV',
						src: '#content',
						init: function() {
							var navHtml = latinBodin.buildNav();
							jQuery('#sidecart_latin #nav-1').html( navHtml );
						},
						refresh: function() {}
					},
					{
						id: 'nav-2',
						type: 'notes',
						link: 'NOTES',
						src: '#content',
						init: function() {},
						refresh: function() {}
					},
				]
			});
			
			//------------------------------------------------------------
			//  Side Cart English
			//------------------------------------------------------------
			jQuery('#sidecart_english').sidecart({
				side: 'top',
				inside: true,
				views: [
					{
						id: 'nav-1',
						type: 'nav',
						link: 'NAV',
						src: '#content',
						init: function() {},
						refresh: function() {
							var navHtml = englishBodin.buildNav();
							jQuery('#sidecart_english #nav-1').html( navHtml );
						}
					},
					{
						id: 'nav-2',
						type: 'notes',
						link: 'NOTES',
						src: '#content',
						init: function() {},
						refresh: function() {}
					},
				]
			});
		}
	</script>
<html>
